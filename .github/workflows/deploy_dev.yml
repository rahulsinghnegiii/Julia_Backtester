name: CI-dev

on:
  push:
    branches:
      - 'master'

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v3
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      -
        name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push Backtesting Service Dockerfile
        uses: docker/build-push-action@v4
        with:
          context: ./App
          file: ./App/Dockerfile
          push: true
          tags: algozen/backtesting-dev:backtesting_service_v2
          build-args: |
            LIVE_DATA_API_URL=${{ secrets.DEV_LIVE_DATA_API_URL }}
            LIVE_DATA_API_USERNAME=${{ secrets.LIVE_DATA_API_USERNAME }}
            LIVE_DATA_API_SECRET=${{ secrets.LIVE_DATA_API_SECRET }}

      - name: Send mail
        if: failure()
        uses: dawidd6/action-send-mail@v2
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: olarmdev@gmail.com
          password: uljx dwix huul nhbz
          subject: Deployment ${{ job.status }} - ${{ github.workflow }} - ${{ github.repository }}
          body: |
            The ${{ github.workflow }} workflow of the ${{ github.repository }} repository has completed with the status: ${{ job.status }}.
          to: afrasyabafzal5@gmail.com,Hassan789@gmail.com
          from: Algozen
      - name: Send Discord notification
        uses: rjstone/discord-webhook-notify@v1
        if: success()
        with:
          severity: info
          details: ${{ github.workflow }} - ${{ github.repository }} - success
          webhookUrl: ${{ secrets.SUCCESS_WEBHOOK }}

      - name: Send Discord notification
        uses: rjstone/discord-webhook-notify@v1
        if: failure()
        with:
          severity: error
          details: ${{ github.workflow }} - ${{ github.repository }} - failure
          webhookUrl: ${{ secrets.FAILURE_WEBHOOK }}
