module SyntheticStockTests
using Dates, DataFrames, Test, JSON
include("./../../Main.jl")
include("../../BacktestUtils/BacktestUtils.jl")

using .VectoriseBacktestService
using .VectoriseBacktestService.GlobalServerCache
using .BacktestUtilites
initialize_server_cache()

# Cases:
# 1. synthetic stock used but indicator is current price => throw error
# 2. synthetic stock used in folder itself => throw error
# 4. synthetic stock doesn't exist in strategy => throw error
# 3. good case where synthetic stock isn't used in itself && indicator is NOT current price && synthetic folder exists in strategy
# 5. synthetic stock used in if-condition but path was empty
function test_good_case()
    @testset "test_good_case" begin
        json_path = "./App/Tests/TestsJSON/SyntheticStockJSON/valid.json"
        end_date = Date("2024-10-01")
        returns = handle_backtesting(json_path, 1000, end_date)
        expected_returns = Float32[
            0.0,
            -0.014900329,
            -0.012195953,
            0.0045523522,
            0.001510574,
            -0.0023310024,
            0.0126443105,
            -0.0027823017,
            0.00074855395,
            -0.0047599617,
            -0.00034213768,
            -0.0033540968,
            0.0017857143,
            0.020773344,
            0.0014104373,
            0.013547954,
            -0.0061540497,
            -0.025501031,
            0.002323039,
            0.010156782,
            0.010257103,
            -0.00060116226,
            -0.008421334,
            -0.0055270963,
            0.0071844924,
            0.030417228,
            -0.0084247645,
            0.0044786935,
            0.00747492,
            0.0042303936,
            0.015489306,
            -0.010083605,
            -0.006704919,
            -0.033101838,
            0.0038934012,
            -0.009562019,
            0.0061436673,
            -0.001610414,
            -0.018348007,
            -0.021361085,
            0.0034280117,
            0.016872343,
            0.006719232,
            0.00061295374,
            -0.010549959,
            -0.023801334,
            0.006482982,
            -0.009311769,
            0.008127209,
            -0.024605678,
            0.014158402,
            0.0063071363,
            0.009084507,
            -0.0027217532,
            -0.0006298111,
            -0.009103004,
            -0.004239983,
            0.020225676,
            0.007512521,
            0.011806131,
            0.015080177,
            0.0033611185,
            0.0014739381,
            -0.005284988,
            -0.00033627008,
            0.0045748116,
            -0.0031476025,
            0.024991602,
            -0.0181556,
            -0.0056074765,
            0.0071160044,
            0.0097986935,
            -0.0034985808,
            0.0035771066,
            -0.005552618,
            0.0024594523,
            -0.019163186,
            -0.00033802056,
            0.014336918,
            6.667111f-5,
            0.006666667,
            0.016490066,
            0.02853606,
            0.016975993,
            0.002927437,
            0.0024220594,
            0.0032835635,
            -0.0316784,
            0.021873605,
            0.03157763,
            -0.0032062917,
            -0.0061297566,
            -0.011724475,
            0.021502718,
            0.035446405,
            0.022783035,
            -0.0029700708,
            0.02801329,
            -0.020674283,
            -0.008023216,
            0.02850915,
            -0.039263804,
            -0.0065017994,
            -0.0081220055,
            0.019086892,
            0.015318804,
            0.0036438168,
            0.022974813,
            -0.005767205,
            0.00050198,
            -0.006578214,
            -0.0035353536,
            0.025004223,
            -0.0126916105,
            -0.02659989,
            -0.016693346,
            0.0009883721,
            0.00011616426,
            0.016783785,
            0.0025702536,
            -0.019028086,
            0.0051106336,
            -0.01889409,
            -0.021024736,
            -0.010347109,
            -0.012765181,
            -0.0048642326,
            -0.011384729,
            -0.0005632745,
            -0.0029432024,
            0.06977767,
            0.026125755,
            -0.00097265135,
            0.00704427,
            -0.016719745,
            -0.00167727,
            -0.0042345845,
            0.018466737,
            0.008293771,
            -0.02359882,
            -0.020218452,
            0.00142315,
            0.023152534,
            -0.0013889692,
            -0.021269197,
            -0.0093557555,
            -0.017812314,
            -0.025864167,
            0.016680202,
            0.012965467,
            0.0016378526,
            -0.011627907,
            0.020588236,
            -0.001981268,
            -0.01840823,
            -0.023717595,
            -0.011676083,
            0.03499746,
            -0.027186254,
            -0.023908654,
            -0.026562398,
            0.029677333,
            0.02901541,
            0.0064540384,
            0.02091894,
            0.008537627,
            0.020800581,
            0.008233622,
            0.022677869,
            0.00373413,
            0.00503663,
            0.019134397,
            -0.0066495305,
            -0.017775778,
            -0.0017181147,
            0.02369342,
            -0.01894194,
            -0.018450817,
            0.0018041087,
            -0.011908911,
            -0.025515903,
            0.011523379,
            0.016342599,
            -0.029988263,
            -0.001330994,
            0.014115224,
            -0.0010155317,
            -0.0048436285,
            -0.027821176,
            0.0067371284,
            -0.037328094,
            -0.0014668368,
            0.04515552,
            -0.036604743,
            0.0019663812,
            0.009622689,
            0.04100828,
            -0.05571618,
            0.0047202907,
            -0.03318922,
            0.016112061,
            -0.051841304,
            -0.026894199,
            0.031916387,
            -0.010672286,
            0.025422564,
            -0.05641919,
            -0.024641385,
            0.0017473608,
            0.040119193,
            -0.019215988,
            0.0011399259,
            0.023199545,
            0.04075671,
            -0.005346164,
            -0.00087342114,
            0.016811244,
            -0.038555652,
            0.0052276794,
            0.017585877,
            -0.005043373,
            -0.035955664,
            -0.038628716,
            -0.03828484,
            0.006672733,
            0.020111479,
            -0.03965148,
            0.011533138,
            0.032760717,
            -0.0038271877,
            0.021573698,
            0.02451725,
            0.0,
            -0.029789638,
            0.013023865,
            -0.018027725,
            0.016164424,
            0.018930396,
            0.009607234,
            0.02399944,
            0.004714725,
            -0.014757889,
            0.006833713,
            -0.002536679,
            0.020482507,
            0.011450125,
            -0.020643272,
            0.02672197,
            0.013509934,
            0.015094093,
            -0.008110718,
            -0.007398274,
            -0.008826414,
            0.03423483,
            0.0035716563,
            0.03279314,
            -0.0061534676,
            -0.009287351,
            0.03824761,
            -0.0019262023,
            -0.0013871299,
            -0.0029029332,
            0.00030326925,
            0.026194518,
            -0.0044315765,
            0.021425605,
            0.006333527,
            -0.00092384085,
            0.008784604,
            -0.002291607,
            -0.015101924,
            -0.023029385,
            -0.0020290029,
            0.0017939365,
            0.014922701,
            -0.03769923,
            -0.013690258,
            -0.01530549,
            -0.01063495,
            0.0047067804,
            -0.013611041,
            -0.008215134,
            0.009253867,
            -0.009617851,
            0.018839829,
            0.038507976,
            -0.05867956,
            0.009555383,
            -0.018929882,
            -0.010960163,
            0.025082946,
            0.015665459,
            -0.020267686,
            -0.0063752276,
            -0.01512374,
            0.0022601874,
            0.006566293,
            -0.012651555,
            -0.04911906,
            -0.030039303,
            0.030752532,
            0.025623025,
            0.0020533882,
            -0.006625683,
            -0.036718696,
            0.0023556284,
            -0.010254949,
            -0.004604979,
            0.033612836,
            -0.03224002,
            0.029122707,
            0.009409452,
            0.0007652174,
            -0.0032670652,
            0.027059069,
            0.014802744,
            0.01933757,
            -0.01962715,
            -0.03046535,
            0.075552486,
            -0.015410299,
            -0.017542716,
            -0.037305012,
            -0.04240502,
            -0.0019441245,
            0.003902298,
            0.0041750646,
            -0.033189964,
            0.088974565,
            0.019268742,
            -0.009485638,
            0.011869436,
            -0.008331112,
            0.012971302,
            0.0037818472,
            -0.021680217,
            0.0146611715,
            0.005926222,
            -0.019593567,
            -0.026264263,
            -0.021148246,
            0.048593894,
            0.0018915085,
            -0.003371317,
            -0.007983222,
            -0.02536998,
            -0.013784899,
            0.012132823,
            -0.0034349808,
            0.016389983,
            0.0067824763,
            -0.015535849,
            -0.04685427,
            -0.014578755,
            -0.015909597,
            -0.00052882073,
            0.023809524,
            -0.02377261,
            -0.0027981547,
            -0.013878356,
            -0.030685227,
            0.028324341,
            0.0024689452,
            -0.037404757,
            0.010314224,
            -0.010604622,
            0.03679411,
            0.0040888754,
            0.0044563967,
            0.021112217,
            -0.00059929583,
            0.010119181,
            0.008756308,
            -0.005370016,
            0.00044375416,
            0.019220818,
            0.0235004,
            0.010063072,
            -0.0047007645,
            0.014803328,
            0.013684357,
            -0.020078119,
            0.009020979,
            0.007900756,
            0.037062503,
            0.024399947,
            -0.017928803,
            0.019244712,
            -0.017652765,
            -0.0069115325,
            0.0024524424,
            0.018806702,
            -0.0042248946,
            0.013903394,
            -0.010429408,
            -0.0075466787,
            -0.026679777,
            0.002896013,
            0.0032905783,
            -0.018005354,
            0.008247564,
            -0.0034478097,
            -0.01424598,
            0.0041291034,
            0.035090122,
            0.018539364,
            -0.014496522,
            0.008377309,
            -0.014914634,
            -0.013878743,
            0.013265993,
            0.014089188,
            0.0026214037,
            0.018694032,
            -0.0054539624,
            0.015483871,
            0.011944092,
            -0.009103466,
            0.006969524,
            0.008305543,
            -0.012293291,
            -0.0039802883,
            0.019790675,
            0.009889904,
            0.015644247,
            0.007701637,
            -0.003249684,
            -0.011290225,
            0.0054958477,
            -0.015972307,
            -0.007591187,
            -0.0043532336,
            0.034103684,
            -0.0021140373,
            0.000121058045,
            0.0075046904,
            0.0069682226,
            -0.005846209,
            -0.009780978,
            0.0018785602,
            -0.009435674,
            -6.106125f-5,
            0.028395213,
            0.00754112,
            -0.0005304102,
            -0.0061914027,
            -0.0064673075,
            -0.009913407,
            0.046926834,
            -0.0004032955,
            -0.009971182,
            0.0103918025,
            0.0011235632,
            -0.005410072,
            -0.002897375,
            0.0,
            0.0036031848,
            0.013666107,
            0.00062839186,
            -0.0054807034,
            -0.015154994,
            0.001632082,
            0.0066922717,
            0.014104862,
            0.010659522,
            -0.0002820079,
            0.016022567,
            0.00477539,
            -0.0075711524,
            -0.002060363,
            -0.0077562635,
            0.015465077,
            0.0021598272,
            0.015638815,
            -0.0026116765,
            0.0034913535,
            0.011198696,
            -0.0058599,
            0.00048669695,
            -0.005675369,
            0.016525332,
            -0.0017112299,
            -0.007553032,
            0.015059103,
            0.006327768,
            0.0017965654,
            0.023102485,
            -0.007784709,
            -0.00587135,
            0.0025087546,
            -0.0058912467,
            -0.010855884,
            -0.0028100312,
            0.008985538,
            0.0040575434,
            0.00078723626,
            0.017305575,
            -0.0013402753,
            0.0070716976,
            -0.010097386,
            -0.006161653,
            0.004220069,
            0.0045136185,
            0.004544985,
            -0.006580977,
            0.013507918,
            0.0031660113,
            -0.004301349,
            -0.0154648395,
            -0.0073216325,
            -0.048020087,
            -0.017253695,
            0.0053117136,
            -0.008954394,
            -0.0012346372,
            0.00033713548,
            0.009393104,
            -0.011200268,
            -0.004959143,
            -0.014555134,
            0.002816092,
            0.007736833,
            0.007904913,
            0.02194888,
            -0.026170494,
            0.012643157,
            0.008846089,
            0.021810312,
            0.01917228,
            0.0011723954,
            0.008463299,
            0.0012667582,
            -0.035793357,
            -0.029249357,
            0.0034917775,
            0.0066225166,
            -0.01706066,
            -0.011854793,
            0.008782504,
            -0.0041538635,
            0.016913319,
            0.006180817,
            -0.019992182,
            -0.008889396,
            0.0049445177,
            0.007380285,
            -0.023398455,
            -0.008897418,
            0.0015255531,
            0.0030464586,
            0.014835582,
            -0.007769784,
            0.0073085846,
            0.007197973,
            0.014750443,
            0.0084511805,
            -0.0033521426,
            0.00790403,
            0.005061179,
            -0.010292734,
            -0.00072686607,
            -0.008784691,
            -0.0073948633,
            -0.0021610556,
            -0.014704206,
            0.0006941231,
            0.0025433525,
            -0.013491698,
            -0.024605494,
            0.007969321,
            0.012305315,
            0.002818721,
            0.018738654,
            0.020693222,
            -0.0051810555,
            0.0146051515,
            0.014450706,
            0.005884941,
            -0.0026245285,
            0.023189519,
            -0.008583691,
            0.014285714,
            0.003040973,
            0.009042072,
            -0.00010542407,
            0.0092782965,
            -0.0042308695,
            0.0035144775,
            -0.0070043383,
            -0.00094751804,
            0.0032140787,
            -0.005409664,
            0.0030627872,
            0.006791261,
            -0.009464547,
            0.02106319,
            -0.005687106,
            0.010139351,
            0.0074123642,
            -0.01292729,
            0.007920074,
            0.01669149,
            0.0007577288,
            -0.0027257584,
            -0.008503315,
            0.005360151,
            -0.010713923,
            -0.00076990196,
            -0.0055475654,
            -0.0028409092,
            0.0005180005,
            0.002226249,
            -0.005424114,
            -0.035786632,
            -0.0074876104,
            -0.012700136,
            -0.0040129735,
            0.024174854,
            -0.0022634189,
            0.005671384,
            -0.0032225146,
            0.0017781131,
            -0.012317126,
            -0.0051734466,
            0.032570615,
            0.015533054,
            0.012163291,
            0.006653257,
            -0.0034839634,
            -0.0016966581,
            -0.009012721,
            -0.0035859058,
            -0.019245815,
            -0.019357584,
            0.013340564,
            -0.0054051164,
            0.00984665,
            0.008631714,
            0.00058108824,
            -0.005754712,
            0.004088785,
            -0.009001853,
            -0.011274379,
            -0.0048097707,
            -0.0015748031,
            -0.008430327,
            -0.004113872,
            0.004185944,
            0.011243966,
            -0.01003417,
            -0.007451238,
            0.008114374,
            -0.0066254176,
            -0.003693088,
            -0.0060304287,
            -0.025381276,
            -0.02844089,
            -0.0058782035,
            -0.00070955534,
            0.010236686,
            0.011831547,
            0.0027785818,
            -0.0121226115,
            0.010927365,
            -0.0021965317,
            0.0063723787,
            0.013585079,
            0.014709223,
            -0.040857445,
            0.0053101475,
            -0.008300441,
            -0.0066725197,
            0.021212656,
            -0.010559114,
            -0.008455796,
            -0.006998765,
            0.0047974414,
            -0.0048924256,
            0.0045018364,
            -0.0066635218,
            0.007242505,
            -0.01113927,
            0.04327095,
            0.0086266,
            -0.021863494,
            -0.019167295,
            -0.008147361,
            -0.0057142857,
            -0.012212643,
            0.005090909,
            0.0063917027,
            0.012702217,
            0.0051473198,
            -0.0034728353,
            0.024808032,
            -0.018270893,
            -0.006047085,
            0.022031896,
            0.059816215,
            -0.009106773,
            0.0037972594,
            0.001864035,
            0.010014228,
            -0.006880858,
            0.017645452,
            0.006173502,
            0.012217895,
            0.00063251104,
            0.00015802782,
            0.0061621107,
            0.006857203,
            -0.0075383415,
            -0.021058146,
            0.016588185,
            5.263712f-5,
            0.0015790305,
            0.005255137,
            0.0050185584,
            0.009258778,
            0.0016492296,
            0.0078209415,
            -0.0070965434,
            0.01239202,
            -0.019147748,
            0.07264913,
            0.028578324,
            0.0054911533,
            -0.00816841,
            0.019671515,
            -0.010984447,
            -0.021512903,
            -0.0104444865,
            0.0031326811,
            0.0044681462,
            0.019993303,
            0.003985932,
            -0.016254086,
            0.029104548,
            0.016239908,
            0.00581105,
            0.021620402,
            0.0065388354,
            0.00377491,
            0.018803569,
            -0.023220878,
            0.01305093,
            0.016743299,
            0.0017918089,
            -0.025295971,
            -0.020534778,
            0.00057989114,
            -0.0015603406,
            0.004688337,
            -0.028754277,
            -0.0048046126,
            0.0021610188,
            0.0012846394,
            0.0025659825,
            0.01499086,
            -0.016750721,
            0.00686939,
            -0.048167016,
            -0.009748172,
            0.012498191,
            0.016633304,
            0.013735877,
            0.0071217166,
            0.01719303,
            0.0020337144,
            0.013530579,
            0.0059184763,
            -0.000707808,
            0.0027446987,
            -0.00048562977,
            -0.008259717,
            0.0102881575,
            0.0014988538,
            0.0037415265,
            -0.0067534973,
            0.014570179,
            -0.0034379216,
            -0.02720524,
            -0.008618754,
            0.006927779,
            -0.007015019,
            0.0004075718,
            -0.0036213843,
            0.011585116,
            0.00049402675,
            -0.0012120124,
            -0.02777528,
            0.002172707,
            0.01798976,
            0.037065566,
            -0.002927426,
            -0.007581069,
            0.0039740363,
            -0.004398118,
            0.0050801784,
            0.0011867088,
            0.022871943,
            -0.029141631,
        ]
        for i in 1:length(expected_returns)
            @test isapprox(returns[i], expected_returns[i], atol=1e-2)
        end
        if isdir("./Cache/")
            rm("./Cache/"; recursive=true)
        end
        if isdir("./IndicatorData/")
            rm("./IndicatorData/"; recursive=true)
        end
    end
    return nothing
end

function test_currentprice_indicator()
    @testset "test_currentprice_indicator" begin
        json_path = "./App/Tests/TestsJSON/SyntheticStockJSON/current_price.json"
        end_date = Date("2024-10-01")
        @test_throws r"ConditionEvalError" handle_backtesting_api(
            read_json_file(json_path), 50000, "current_price_hash", end_date
        )

        if isdir("./Cache/")
            rm("./Cache/"; recursive=true)
        end
        if isdir("./IndicatorData/")
            rm("./IndicatorData/"; recursive=true)
        end
    end
    return nothing
end

function test_recursion_indicator()
    @testset "test_recursion_indicator" begin
        json_path = "./App/Tests/TestsJSON/SyntheticStockJSON/recursion.json"
        json_file = JSON.parse(read(json_path, String))
        end_date = Date("2024-10-01")
        @test_throws r"ConditionEvalError" handle_backtesting_api(
            json_file, 1000, "recursion_hash", end_date
        )

        if isdir("./Cache/")
            rm("./Cache/"; recursive=true)
        end
        if isdir("./IndicatorData/")
            rm("./IndicatorData/"; recursive=true)
        end
    end
    return nothing
end

function test_no_folder_indicator()
    @testset "test_no_folder_indicator" begin
        json_path = "./App/Tests/TestsJSON/SyntheticStockJSON/no_folder.json"
        json_file = JSON.parse(read(json_path, String))
        end_date = Date("2024-10-01")
        @test_throws r"ConditionEvalError" handle_backtesting_api(
            json_file, 1000, "no_folder_hash", end_date
        )

        if isdir("./Cache/")
            rm("./Cache/"; recursive=true)
        end
        if isdir("./IndicatorData/")
            rm("./IndicatorData/"; recursive=true)
        end
    end
    return nothing
end

function test_empty_path_indicator()
    @testset "test_empty_path_indicator" begin
        json_path = "./App/Tests/TestsJSON/SyntheticStockJSON/empty_path.json"
        json_file = JSON.parse(read(json_path, String))
        end_date = Date("2024-10-01")
        @test_throws r"ArgumentError" handle_backtesting_api(
            json_file, 1000, "empty_path_hash", end_date
        )

        if isdir("./Cache/")
            rm("./Cache/"; recursive=true)
        end
        if isdir("./IndicatorData/")
            rm("./IndicatorData/"; recursive=true)
        end
    end
    return nothing
end

end

SyntheticStockTests.test_good_case()
SyntheticStockTests.test_currentprice_indicator()
SyntheticStockTests.test_recursion_indicator()
SyntheticStockTests.test_no_folder_indicator()
SyntheticStockTests.test_empty_path_indicator()
